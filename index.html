<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãã‚Šä¸‹ãŒã‚Šã®ã‚ã‚‹ã²ãç®—ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã‚ˆã†</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f0f9ff;
            --panel-bg: #ffffff;
            --primary-color: #4da3ff;
            --accent-color: #ff9800;
            --text-color: #333333;
            --border-color: #cccccc;
            --block-yellow: #ffd600; 
            --success-color: #4caf50;
            --level-color: #ff5252;
            --counter-color: #9c27b0;
            --main-font: "UD Digi Kyokasho N-R", "UD Digi Kyokasho", "UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ N-R", "UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“", "BIZ UDPGothic", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            --coin-font: "Times New Roman", "YuMincho", "Hiragino Mincho ProN", "Yu Mincho", "MS PMincho", serif;
            
            --block-unit: 24px; 
        }

        body { 
            font-family: var(--main-font); 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh;
            width: 100vw;
            touch-action: none; 
            overflow: hidden; 
            -webkit-touch-callout: none;
            user-select: none;
        }

        /* ãƒ­ãƒ¼ãƒ‰ä¸­ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            z-index: 20000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }
        .loading-icon {
            font-size: 4rem;
            animation: bounce 1.5s infinite;
        }
        .loading-text {
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: bold;
            margin-top: 15px;
        }

        .app-container { 
            width: 100%; 
            max-width: 1200px; 
            height: 98vh; 
            background-color: var(--panel-bg); 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            padding: 5px 12px; 
            box-sizing: border-box; 
            display: flex;
            flex-direction: column;
            position: relative;
        }

        header { text-align: center; margin-bottom: 2px; border-bottom: 1px dashed var(--border-color); padding-bottom: 2px; position: relative; }
        h1 { font-size: 2.2rem; color: var(--primary-color); margin: 2px 0 5px 0; font-weight: 700; text-shadow: 1px 1px 0 #fff; }

        .controls { display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap; position: relative; padding-top: 5px; }
        
        .formula-row { display: flex; align-items: center; gap: 4px; font-size: 1.1rem; background: #f9f9f9; padding: 4px 12px; border-radius: 8px; border: 1px solid #eee; }
        .num-input { width: 54px; height: 36px; font-size: 1.5rem; text-align: center; border: 2px solid var(--border-color); border-radius: 6px; font-family: var(--main-font); }
        .header-answer { background-color: #f0f0f0; border-color: #aaa; color: var(--primary-color); font-weight: bold; }

        .btn { 
            color: white !important; border: none; padding: 8px 20px; font-size: 1rem; border-radius: 50px; cursor: pointer; font-weight: bold; 
            transition: transform 0.1s, box-shadow 0.1s; white-space: nowrap; font-family: var(--main-font); 
        }
        .btn:active { transform: translateY(1px); }

        #back-to-home-btn {
            background-color: #90a4ae; 
            font-size: 0.8rem; 
            padding: 4px 12px; 
            position: absolute; 
            left: 5px;
            top: 0px; 
            z-index: 1000;
        }

        .start-action-box {
            border: 4px solid gold;
            background-color: #fffde7;
            border-radius: 20px;
            padding: 10px;
            margin: 5px auto;
            width: fit-content;
            min-width: 250px;
            text-align: center;
        }

        #start-btn { 
            background-color: var(--primary-color); 
            box-shadow: 0 4px 0 #2a75c7; 
            font-size: 1.5rem; 
            padding: 12px 30px; 
            margin: 0 auto; 
            animation: pulse 2s infinite;
            display: block;
            width: 100%;
            border-radius: 50px;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        
        #next-btn { background-color: var(--success-color) !important; box-shadow: 0 3px 0 #388e3c; display: none; }
        #reset-progress-btn { background-color: #78909c; font-size: 0.8rem; padding: 2px 8px; border-radius: 8px; box-shadow: 0 2px 0 #546e7a; color: white; border: none; cursor: pointer; }

        .control-group { display: flex; align-items: center; gap: 8px; background: #fff; padding: 4px 10px; border-radius: 8px; border: 1px solid #f0f0f0; flex-wrap: wrap; justify-content: center; }

        .mode-radio-group { display: flex; gap: 15px; align-items: center; justify-content: flex-start; margin-top: 2px; }
        .mode-radio-label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: bold; font-size: 0.95rem; padding: 4px 8px; border-radius: 10px; transition: background 0.2s; }
        .mode-radio-label:hover { background: rgba(0,0,0,0.05); }
        .mode-radio-label input { cursor: pointer; width: 16px; height: 16px; margin: 0; }

        .auto-answer-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 1.3rem; 
            font-weight: 700;
            color: var(--counter-color);
        }
        .auto-answer-label input[type="checkbox"] {
            width: 28px;  
            height: 28px; 
            cursor: pointer;
            margin: 0;
        }

        .mini-icon { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; font-size: 10px; pointer-events: none; }
        .mini-coin { background: radial-gradient(circle at 30% 30%, #ffffff, #e0e0e0 40%, #bfbfbf 90%); border: 1px solid #a0a0a0; color: #555; font-family: serif; }
        .mini-block { background-color: var(--block-yellow); border: 1px solid #9c7c00; border-radius: 2px; width: 20px; height: 20px; }

        .instruction-area { 
            background-color: #fff9c4; border-radius: 12px; padding: 10px 15px; margin: 2px auto; width: 98%; 
            flex: 1; display: flex; flex-direction: column; justify-content: start; overflow-y: auto;
        }
        .instruction-section { 
            margin-bottom: 8px; padding: 8px 12px; background: rgba(255,255,255,0.7); border-radius: 10px; 
            text-align: left; 
        }
        .instruction-title { 
            font-size: 1.1rem; color: #f57f17; font-weight: bold; margin-bottom: 4px; 
            display: inline-block; border-bottom: 2px solid #f57f17; 
        }
        
        /* æº–å‚™ã‚¨ãƒªã‚¢ã®ã‚°ãƒªãƒƒãƒ‰ã‚’3åˆ—ã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†è‡ªå‹•èª¿æ•´ã«ä¿®æ­£ */
        .setup-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 15px; text-align: left; max-width: 950px; margin: 0 auto; }
        .setup-item { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; border-radius: 8px; } 
        .icon-box { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: #fff; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 1.1rem; flex-shrink: 0; }

        .visual-guide-container { display: flex; justify-content: space-around; gap: 10px; margin-top: 5px; }
        .visual-guide-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; background: #fff; padding: 10px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .visual-guide-item svg { width: 100%; max-width: 140px; height: auto; }
        .visual-guide-text { font-size: 0.9rem; font-weight: bold; color: #333; line-height: 1.4; text-align: center; }
        
        .level-badge, .title-badge, .counter-badge { padding: 4px 12px; border-radius: 12px; font-weight: bold; font-size: 0.9rem; color: white; }
        .level-badge { background: var(--level-color); }
        .title-badge { background: var(--primary-color); }
        .counter-badge { background: var(--counter-color); }

        /* è¦–ç·šèª˜å°ç”¨ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæ ï¼ˆç‚¹æ»…ï¼‰ */
        .highlight-border {
            position: relative;
        }
        .highlight-border::after {
            content: '';
            position: absolute;
            top: -6px; left: -6px; right: -6px; bottom: -6px;
            border: 4px dashed #ff5722;
            border-radius: inherit; /* è¦ç´ ã®ä¸¸ã¿ã‚’ç¶™æ‰¿ */
            pointer-events: none;
            animation: blink-highlight 0.8s infinite;
            z-index: 1000;
        }
        @keyframes blink-highlight {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }

        /* ãã‚Šä¸‹ãŒã‚Šæ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ï¼ˆ1ã¤ã®ç¹‹ãŒã£ãŸèµ¤ã„ç‚¹æ»…æ ï¼‰ */
        .joined-highlight {
            position: absolute;
            box-sizing: border-box;
            border: 4px dashed #f44336; /* èµ¤è‰² */
            border-radius: 8px; 
            pointer-events: none;
            animation: blink-highlight-red 0.8s infinite;
            z-index: 1000;
            box-shadow: 0 0 8px rgba(244, 67, 54, 0.4) inset, 0 0 8px rgba(244, 67, 54, 0.4);
        }
        @keyframes blink-highlight-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }

        /* ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ */
        .workspace { display: none; flex-direction: row; gap: 15px; align-items: stretch; margin-top: 5px; flex: 1; overflow: hidden; min-height: 0; }
        
        .calc-panel { flex: 0 0 320px; background-color: #fafafa; border-radius: 15px; padding: 10px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .calc-wrapper { position: relative; margin-top: 40px; }
        
        .hissan-grid { 
            display: grid; grid-template-rows: 80px 80px 80px 80px; 
            border: 2px solid #555; background: #fff; 
            width: fit-content;
            position: relative; /* æ ã®åŸºæº–ç‚¹ã«ã™ã‚‹ãŸã‚ã«è¿½åŠ  */
        }
        .hissan-grid.cols-3 { grid-template-columns: repeat(3, 80px); }
        .hissan-grid.cols-4 { grid-template-columns: repeat(4, 80px); }

        .hissan-cell { 
            border: 1px solid #ccc; 
            display: flex; align-items: center; justify-content: center; 
            font-family: var(--main-font); 
            font-size: 3.5rem; 
            position: relative; 
            padding-bottom: 4px; 
        }
        
        /* å‹•çš„ã«è¨ˆç®—ç”¨ã®ä¸‹ç·šã‚’å¼•ãã‚¯ãƒ©ã‚¹ */
        .hissan-bottom-line { border-bottom: 3.5px solid #333 !important; }

        .hissan-carry-cell {
            border: 2px dashed transparent;
            font-size: 2.5rem;
            color: #e65100;
            box-sizing: border-box;
        }
        .hissan-carry-cell.active {
            border-color: #ff9800;
            background: #fff3e0;
        }

        .strike-through::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 20%;
            width: 60%;
            height: 4px;
            background-color: blue;
            transform: translateY(-50%) rotate(45deg);
            pointer-events: none;
            z-index: 10;
        }

        .operator { 
            font-size: 3.5rem; 
            line-height: 1;
        }
        
        .hissan-input { 
            width: 100%; height: 100%; border: none; text-align: center; 
            font-size: 3.5rem; 
            color: var(--primary-color); 
            background: transparent; outline: none; 
            font-family: var(--main-font); 
        }

        /* è¦–è¦šãƒ‘ãƒãƒ«ï¼šè¡¨å…¨ä½“ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ä¿®æ­£ */
        .visual-panel { 
            flex: 1; 
            background-color: #fff; 
            border: 1px solid #eee; 
            border-radius: 15px; 
            padding: 5px; 
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0; 
            box-sizing: border-box; 
            display: block;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        /* ãƒ‘ãƒãƒ«å…¨ä½“ã¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .visual-panel::-webkit-scrollbar { width: 8px; }
        .visual-panel::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 4px; }
        .visual-panel::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
        .visual-panel::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.4); }
        
        .coin-table { 
            display: grid; 
            /* æœ€å¾Œã®è¡Œ(ç­”ãˆã®æ )ãŒå†…å®¹ã«åˆã‚ã›ã¦ä¼¸ã³ã‚‹ã‚ˆã†ã«è¨­å®š */
            grid-template-rows: auto auto auto minmax(140px, auto); 
            gap: 1px; 
            background-color: #666; 
            border: 2px solid #666; 
            width: 100%; 
            max-width: 100%;
            position: relative;
            overflow: visible; /* çŸ¢å°ãŒã¯ã¿å‡ºã—ã¦ã‚‚è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ */
        }
        
        .coin-table.mode-coin { grid-template-columns: 1fr 1fr 1fr; }
        .coin-table.mode-block { grid-template-columns: 1fr 1fr 1fr; }

        .col-hundred { background-color: #fff0f5 !important; }
        .col-header-hundred { background-color: #ff8a80 !important; color: #fff; }
        .col-ten { background-color: #fffce0 !important; }
        .col-header-ten { background-color: #ffd600 !important; color: #555; }
        .col-one { background-color: #f0f8ff !important; }
        .col-header-one { background-color: #42a5f5 !important; color: #fff; }

        .col-header { text-align: center; font-weight: bold; padding: 5px; font-size: 0.9rem; }
        
        /* z-indexã‚’ç´°ã‹ãåˆ¶å¾¡ã—ã€çŸ¢å°ãŒæ ç·šã‚„éš£ã®ã‚»ãƒ«ã«éš ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
        .coin-zone { min-height: 110px; padding: 5px; position: relative; }
        .coin-zone[data-row="mid"] { z-index: 50; }
        .coin-zone[data-row="bot"] { z-index: 150; }
        
        /* çŸ¢å°ãŒå³éš£ã®ã‚»ãƒ«ï¼ˆä¸‹ã®ä½ï¼‰ã«éš ã‚Œãªã„ã‚ˆã†ã€å·¦ã®ä½ã»ã©z-indexã‚’é«˜ãè¨­å®š */
        #zone-top-100 { z-index: 202; }
        #zone-top-10 { z-index: 201; }
        #zone-top-1 { z-index: 200; }
        
        #zone-carry-100 { z-index: 102; }
        #zone-carry-10 { z-index: 101; }
        #zone-carry-1 { z-index: 100; }
        
        .coin-zone.carry-row { min-height: 60px; padding-top: 22px; border-bottom: none; overflow: visible; }
        .coin-zone.carry-row::after { content: "ãã‚Šã•ãŒã‚Š"; position: absolute; top: 2px; left: 5px; font-size: 0.65rem; color: #555; opacity: 0.7; }
        #zone-carry-100::after { display: none !important; }
        
        /* ç­”ãˆã®æ  */
        .coin-zone.result-row { 
            border-top: 4px solid #666; 
        }

        .zone-label { position: absolute; bottom: 2px; left: 5px; font-size: 0.65rem; color: rgba(0,0,0,0.2); pointer-events: none; }

        .token { display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: grab; touch-action: none; user-select: none; transition: transform 0.1s; }
        .token.block { background-color: var(--block-yellow); border: 1.2px solid #9c7c00; box-sizing: border-box; }
        .token.block-1 { width: var(--block-unit); height: var(--block-unit); border-radius: 1px; }
        .token.block-5 { width: calc(var(--block-unit) * 5); height: var(--block-unit); border-radius: 2px; background-image: linear-gradient(to right, rgba(0,0,0,0.15) 1px, transparent 1px); background-size: var(--block-unit) 100%; }
        .token.block-10 { width: calc(var(--block-unit) * 10); height: var(--block-unit); border-radius: 2px; background-image: linear-gradient(to right, rgba(0,0,0,0.15) 1px, transparent 1px); background-size: var(--block-unit) 100%; }
        .token.block-100 { 
            width: calc(var(--block-unit) * 10); 
            height: calc(var(--block-unit) * 10); 
            border-radius: 3px; 
            background-image: linear-gradient(to right, rgba(0,0,0,0.15) 1px, transparent 1px), linear-gradient(to bottom, rgba(0,0,0,0.15) 1px, transparent 1px); 
            background-size: var(--block-unit) var(--block-unit); 
            z-index: 6; 
        }

        .coin-zone.carry-row .block-100 {
            position: absolute;
            top: -40px; 
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .token.coin { border-radius: 50%; box-sizing: border-box; font-family: var(--coin-font); text-shadow: 0px 1px 0px rgba(255,255,255,0.4); box-shadow: inset 0 0 3px rgba(0,0,0,0.3), 1px 2px 4px rgba(0,0,0,0.3); }
        .token.coin.coin-1 { width: 44px; height: 44px; border: 2px solid #a0a0a0; background: radial-gradient(circle at 30% 30%, #ffffff, #e0e0e0 40%, #bfbfbf 90%); color: #555; font-size: 1.2rem; }
        .token.coin.coin-10 { width: 48px; height: 48px; border: 2px solid #8b4513; background: radial-gradient(circle at 35% 35%, #e6a060, #b87333 50%, #8b4513 100%); color: #ffe4c4; box-shadow: inset 0 0 0 3px rgba(100, 50, 10, 0.4), 1px 2px 3px rgba(0,0,0,0.4); font-size: 1.3rem; }
        .token.coin.coin-100 { width: 52px; height: 52px; background: linear-gradient(135deg, #f5f5f5 0%, #dcdcdc 50%, #a9a9a9 100%); color: #333; border: 2px dashed #888; font-size: 1.4rem; }

        .token.ghost { opacity: 0.5 !important; pointer-events: none !important; }
        .token.used { opacity: 0.2 !important; pointer-events: none !important; filter: grayscale(100%); }

        /* è¿½åŠ ï¼šã²ãã‹ãšã‚¾ãƒ¼ãƒ³ï¼ˆä¸­æ®µï¼‰ã«ç½®ã‹ã‚ŒãŸã‚³ã‚¤ãƒ³ã‚„ãƒ–ãƒ­ãƒƒã‚¯ã¯30%ã®é€éã«ã™ã‚‹ */
        .coin-zone[data-row="mid"] .token { opacity: 0.3 !important; }
        
        .token-container { display: flex !important; flex-direction: row; flex-wrap: wrap; gap: 2px !important; width: fit-content; justify-content: center; align-items: start; }
        .container-grid { display: grid !important; grid-template-columns: repeat(5, auto) !important; gap: 4px !important; }
        .container-coin-ten { display: grid !important; grid-template-columns: repeat(5, auto) !important; gap: 4px !important; }
        .container-ten { flex-direction: column !important; gap: 2px !important; }
        
        .coin-table.mode-block .col-one .container-grid { display: flex !important; flex-wrap: wrap !important; width: 100% !important; gap: 4px !important; align-items: center; justify-content: flex-start; }

        /* è¿½åŠ ï¼šãƒ–ãƒ­ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ç™¾ã®ä½ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’é‡ã­ã¦ï¼ˆã‚¹ã‚¿ãƒƒã‚¯ï¼‰è¡¨ç¤ºã™ã‚‹è¨­å®š */
        .coin-table.mode-block .col-hundred .token-container {
            position: relative;
            width: calc(var(--block-unit) * 10 + 45px);
            height: calc(var(--block-unit) * 10 + 45px);
            display: block !important;
            margin: 0 auto;
        }
        .coin-table.mode-block .col-hundred .token-container .token.block-100 {
            position: absolute;
            box-shadow: -2px 2px 4px rgba(0,0,0,0.3), 1px 1px 1px rgba(255,255,255,0.5) inset; /* é‡ãªã‚ŠãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«å½±ã‚’ã¤ã‘ã‚‹ */
        }
        /* æšæ•°ã«å¿œã˜ã¦å°‘ã—ãšã¤å³ä¸‹ã«ãšã‚‰ã™ */
        .coin-table.mode-block .col-hundred .token-container .token.block-100:nth-child(1) { top: 0px; left: 0px; z-index: 1; }
        .coin-table.mode-block .col-hundred .token-container .token.block-100:nth-child(2) { top: 5px; left: 5px; z-index: 2; }
        .coin-table.mode-block .col-hundred .token-container .token.block-100:nth-child(3) { top: 10px; left: 10px; z-index: 3; }
        .coin-table.mode-block .col-hundred .token-container .token.block-100:nth-child(4) { top: 15px; left: 15px; z-index: 4; }
        .coin-table.mode-block .col-hundred .token-container .token.block-100:nth-child(5) { top: 20px; left: 20px; z-index: 5; }
        .coin-table.mode-block .col-hundred .token-container .token.block-100:nth-child(6) { top: 25px; left: 25px; z-index: 6; }
        .coin-table.mode-block .col-hundred .token-container .token.block-100:nth-child(7) { top: 30px; left: 30px; z-index: 7; }
        .coin-table.mode-block .col-hundred .token-container .token.block-100:nth-child(8) { top: 35px; left: 35px; z-index: 8; }
        .coin-table.mode-block .col-hundred .token-container .token.block-100:nth-child(9) { top: 40px; left: 40px; z-index: 9; }

        /* ãŠã‚ã™ãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆæ¨ªå¤ªç·šã®ä½ç½®ï¼‰ */
        .drop-down-btn-container {
            grid-column: 1 / -1;
            position: relative;
            height: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }

        /* ãŠã‚ã™ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .drop-down-btn {
            position: absolute;
            margin-top: 4px; /* æ¨ªç·šã®ã¡ã‚‡ã†ã©ä¸­å¤®ã«é‡ãªã‚‹ã‚ˆã†ã«èª¿æ•´ */
            background: #ff5722;
            color: white !important;
            border: 3px solid #e64a19;
            border-radius: 30px;
            padding: 8px 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            animation: btn-bounce 1.5s infinite;
            font-family: var(--main-font);
            white-space: nowrap;
        }
        .drop-down-btn:active {
            transform: scale(0.95);
        }

        /* ã‚¬ã‚¤ãƒ‰ç”¨ ç‚¹æ»…çŸ¢å°ï¼ˆä¸‹å‘ãï¼‰ */
        .guide-blink-arrow {
            position: absolute;
            bottom: -20px; /* çŸ¢å°ã®çœŸã‚“ä¸­ãŒæ¨ªç·šã‚’ã¾ãŸãã‚ˆã†ã«ä½ç½®ã‚’èª¿æ•´ */
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.5rem;
            color: #ff5722;
            font-weight: bold;
            animation: blink-arrow-anim 1.5s infinite;
            z-index: 900;
            pointer-events: none;
            display: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        @keyframes blink-arrow-anim {
            0%, 100% { opacity: 1; transform: translate(-50%, 0); }
            50% { opacity: 0.2; transform: translate(-50%, 8px); }
        }

        /* ç¹°ã‚Šä¸‹ãŒã‚Šç”¨ å³ä¸ŠçŸ¢å° */
        .guide-blink-arrow-up-right {
            position: absolute;
            top: -10px;
            right: -20px;
            font-size: 3rem;
            color: #9c27b0;
            font-weight: bold;
            animation: blink-arrow-up-right-anim 1.5s infinite;
            z-index: 900;
            pointer-events: none;
            display: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        @keyframes blink-arrow-up-right-anim {
            0%, 100% { opacity: 1; transform: translate(0, 0); }
            50% { opacity: 0.2; transform: translate(25px, -25px); }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } }
        @keyframes btn-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        #feedback-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .big-correct-text { font-size: 5rem; font-weight: 900; color: #ff5722; text-shadow: 4px 4px 0 #fff; opacity: 0; transform: scale(0.5); transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .big-correct-text.show { opacity: 1; transform: scale(1.2); }
        
        .confetti-piece { position: fixed; width: 12px; height: 12px; top: -20px; z-index: 9998; border-radius: 3px; animation-name: fall; animation-timing-function: linear; animation-fill-mode: forwards; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .modal-content { background: white; padding: 25px; border-radius: 30px; text-align: center; border: 5px solid gold; max-width: 90%; }

        .footer-credit {
            text-align: center;
            font-size: 0.75rem;
            color: #888;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        #user-id-footer {
            font-family: monospace;
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        /* ã‚¹ãƒãƒ›å‘ã‘ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¨­å®š */
        @media (max-width: 800px) {
            :root {
                --block-unit: 18px; 
            }
            .workspace { flex-direction: column; overflow-y: auto; align-items: center; }
            .calc-panel { flex: 0 0 auto; width: 100%; max-width: 400px; min-height: 250px; }
            .visual-panel { flex: 0 0 auto; width: 100%; min-height: 400px; overflow-y: visible; }
            
            .token.coin.coin-1 { width: 36px; height: 36px; font-size: 1rem; }
            .token.coin.coin-10 { width: 40px; height: 40px; font-size: 1.1rem; }
            .token.coin.coin-100 { width: 44px; height: 44px; font-size: 1.2rem; }
            
            h1 { font-size: 1.5rem; }
            .formula-row { font-size: 0.9rem; padding: 4px 8px; }
            .num-input { width: 40px; height: 30px; font-size: 1.2rem; }
        }
        
        @media (max-width: 500px) {
            :root {
                --block-unit: 14px; 
            }
            .token.coin.coin-1 { width: 30px; height: 30px; font-size: 0.9rem; }
            .token.coin.coin-10 { width: 34px; height: 34px; font-size: 1rem; }
            .token.coin.coin-100 { width: 38px; height: 38px; font-size: 1.1rem; }
            .hissan-cell { font-size: 2.5rem; }
            .hissan-input { font-size: 2.5rem; }
            .hissan-grid { grid-template-rows: 60px 60px 60px 60px; }
            .hissan-grid.cols-3 { grid-template-columns: repeat(3, 60px); }
            .hissan-grid.cols-4 { grid-template-columns: repeat(4, 60px); }
            .hissan-carry-cell { font-size: 1.8rem; }
            .operator { font-size: 2.5rem; }
        }
    </style>
</head>
<body oncontextmenu="return false;">
    <script>
        setTimeout(function() {
            var el = document.getElementById('loading-overlay');
            if (el && el.style.display !== 'none') {
                el.style.opacity = '0';
                setTimeout(function(){ el.style.display = 'none'; }, 300);
            }
        }, 1500);
    </script>
    
    <div id="loading-overlay">
        <div class="loading-icon">â³</div>
        <div class="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ˆã¿ã“ã¿ã¡ã‚…ã†...</div>
    </div>

    <div id="feedback-overlay"><div id="big-text" class="big-correct-text">ã›ã„ã‹ã„ï¼</div></div>

    <div id="master-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div style="font-size:4rem;">ğŸ†</div>
            <h2 style="color:#ff9800; font-size: 2.2rem;">ã²ã£ç®—ãƒã‚¹ã‚¿ãƒ¼ï¼</h2>
            <p style="font-size: 1.2rem;">30ã‚‚ã‚“ ã›ã„ã‹ã„ ãŠã‚ã§ã¨ã†ï¼<br>ã‚ãªãŸã¯ ã‚‚ã† ã²ãã–ã‚“ã® ã¦ã‚“ã•ã„ã ã­ï¼</p>
            <button class="btn" id="modal-close-btn" style="background: gold; color: #333; margin-top: 20px; font-size: 1.1rem; padding: 10px 30px;">ã‚‚ã£ã¨ ã¤ã¥ã‘ã‚‹ï¼</button>
        </div>
    </div>

    <div class="app-container">
        <header>
            <button id="back-to-home-btn" class="btn" style="display:none;">â—€ ã‚‚ã©ã‚‹</button>
            <h1>ãã‚Šä¸‹ãŒã‚Šã®ã‚ã‚‹ã²ãç®—ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã‚ˆã†</h1>
            
            <div id="header-controls" class="controls" style="display:none;">
                 <div class="formula-row">
                    <span>ã—ãï¼š</span>
                    <input type="number" id="input1" class="num-input" readonly>
                    <span style="font-weight:bold; margin:0 2px;">ãƒ¼</span>
                    <input type="number" id="input2" class="num-input" readonly>
                    <span style="font-weight:bold; margin:0 2px;">ï¼</span>
                    <input type="text" id="header-answer" class="num-input header-answer" readonly>
                </div>
                <button id="next-btn" class="btn">ã¤ãã® ã‚‚ã‚“ã ã„ â¡</button>
                <div class="control-group">
                    <div class="level-badge" id="level-display">ãƒ¬ãƒ™ãƒ«: 1</div>
                    <div class="title-badge" id="title-display">ã—ã‚‡ã†ã”ã†: ã²ãã–ã‚“ ã¿ãªã‚‰ã„</div>
                    <div class="counter-badge" id="counter-display">0ï¼30ã‚‚ã‚“</div>
                </div>
            </div>
        </header>

        <div id="instruction-area" class="instruction-area">
            <!-- è¿½åŠ ï¼šéŸ³å£°ã‚¬ã‚¤ãƒ‰å†ç”Ÿãƒœã‚¿ãƒ³ -->
            <div style="text-align: center; margin-bottom: 10px;">
                <button id="guide-audio-btn" class="btn" style="background-color: #4caf50; font-size: 1rem; padding: 8px 20px; box-shadow: 0 4px 0 #388e3c;">ğŸ”Š ã›ã¤ã‚ã„ã‚’ ãã</button>
            </div>
            
            <div class="instruction-section">
                <div class="instruction-title">1. ã˜ã‚…ã‚“ã³</div>
                <div class="setup-grid">
                    <div class="setup-item">
                        <div class="icon-box">ğŸ’°</div>
                        <div>
                            <strong>ãƒ¢ãƒ¼ãƒ‰ã‚’ ãˆã‚‰ã¼ã†</strong><br>
                            <div class="mode-radio-group">
                                <label class="mode-radio-label">
                                    <input type="radio" name="display-mode-radio" value="coin" checked>
                                    <span class="mini-icon mini-coin">1</span>
                                    <span>ãŠã‹ã­</span>
                                </label>
                                <label class="mode-radio-label">
                                    <input type="radio" name="display-mode-radio" value="block">
                                    <span class="mini-icon mini-block"></span>
                                    <span>ãƒ–ãƒ­ãƒƒã‚¯</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="setup-item">
                        <div class="icon-box">ğŸ¤–</div>
                        <div>
                            <strong><label class="auto-answer-label"><input type="checkbox" id="setting-auto-answer"> ã“ãŸãˆ ã˜ã©ã†</label></strong><br>
                            <span style="font-size:0.8rem; color:#666;">âœ…ã™ã‚‹ã¨ ã˜ã©ã†ã§ ã“ãŸãˆãŒ ã¯ã„ã‚‹ã‚ˆ</span>
                        </div>
                    </div>
                    <!-- ãŠã‚“ã›ã„ã‚¬ã‚¤ãƒ‰è¨­å®šã‚’è¿½åŠ  -->
                    <div class="setup-item">
                        <div class="icon-box">ğŸ”Š</div>
                        <div>
                            <strong><label class="auto-answer-label"><input type="checkbox" id="setting-audio-guide" checked> ãŠã‚“ã›ã„ã‚¬ã‚¤ãƒ‰</label></strong><br>
                            <span style="font-size:0.8rem; color:#666;">âœ…ã™ã‚‹ã¨ ãŠã‚“ã›ã„ã§ ãŠã—ãˆã¦ãã‚Œã‚‹ã‚ˆ</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="instruction-section">
                <div class="instruction-title">3. ã¤ã‹ã„ã‹ãŸ</div>
                <div class="visual-guide-container">
                    <div class="visual-guide-item">
                        <span class="visual-guide-text">â‘  ã²ãã‹ãšã® ã¶ã‚“ã ã‘<br>ãŠã‹ã­ã‚’ ä¸‹ã® ã‚ãã«<br>ã†ã”ã‹ãã†ï¼</span>
                        <svg viewBox="0 0 100 100">
                            <defs><radialGradient id="grad-coin-1" cx="30%" cy="30%"><stop offset="0%" stop-color="#fff"/><stop offset="40%" stop-color="#e0e0e0"/><stop offset="90%" stop-color="#bfbfbf"/></radialGradient></defs>
                            <circle cx="50" cy="22" r="14" fill="url(#grad-coin-1)" stroke="#a0a0a0" stroke-width="1.5" />
                            <text x="50" y="27" text-anchor="middle" font-size="12" fill="#555" font-family="serif" font-weight="bold">1</text>
                            <line x1="50" y1="40" x2="50" y2="60" stroke="#555" stroke-width="3" stroke-linecap="round" />
                            <path d="M42 52 L50 60 L58 52" fill="none" stroke="#555" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                            <rect x="25" y="65" width="50" height="30" rx="5" fill="none" stroke="#999" stroke-width="2" />
                        </svg>
                    </div>
                    <div class="visual-guide-item">
                        <span class="visual-guide-text">â‘¡ ã²ã‘ãªã„ã¨ãã¯<br>ä¸€ã®ãã‚‰ã„ã« ãã‚Šã•ã’ã¦<br>ã°ã‚‰ã« ã—ã‚ˆã†ï¼</span>
                        <svg viewBox="0 0 140 100">
                            <defs>
                                <radialGradient id="grad-coin-10-guide" cx="35%" cy="35%">
                                    <stop offset="0%" stop-color="#e6a060"/>
                                    <stop offset="50%" stop-color="#b87333"/>
                                    <stop offset="100%" stop-color="#8b4513"/>
                                </radialGradient>
                            </defs>
                            
                            <!-- 10å††ç‰ -->
                            <circle cx="20" cy="55" r="14" fill="url(#grad-coin-10-guide)" stroke="#8b4513" stroke-width="1.5" />
                            <text x="20" y="60" text-anchor="middle" font-size="12" fill="#ffe4c4" font-family="serif" font-weight="bold">10</text>
                            
                            <!-- çŸ¢å° -->
                            <text x="44" y="61" text-anchor="middle" fill="#ff5722" font-size="16" font-weight="bold">â†’</text>
                            
                            <!-- 1å††ç‰ã®æ  -->
                            <rect x="56" y="30" width="80" height="50" rx="5" fill="rgba(255,87,34,0.05)" stroke="#ff5722" stroke-width="2" stroke-dasharray="4" />
                            <text x="96" y="24" text-anchor="middle" fill="#ff5722" font-size="10" font-weight="bold">ã°ã‚‰ã«ã™ã‚‹</text>
                            
                            <!-- 1å††ç‰10å€‹ -->
                            <g transform="translate(56, 30)">
                                <circle cx="14" cy="15" r="6" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="14" y="18" text-anchor="middle" font-size="6" fill="#555" font-weight="bold">1</text>
                                <circle cx="27" cy="15" r="6" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="27" y="18" text-anchor="middle" font-size="6" fill="#555" font-weight="bold">1</text>
                                <circle cx="40" cy="15" r="6" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="40" y="18" text-anchor="middle" font-size="6" fill="#555" font-weight="bold">1</text>
                                <circle cx="53" cy="15" r="6" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="53" y="18" text-anchor="middle" font-size="6" fill="#555" font-weight="bold">1</text>
                                <circle cx="66" cy="15" r="6" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="66" y="18" text-anchor="middle" font-size="6" fill="#555" font-weight="bold">1</text>
                                
                                <circle cx="14" cy="35" r="6" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="14" y="38" text-anchor="middle" font-size="6" fill="#555" font-weight="bold">1</text>
                                <circle cx="27" cy="35" r="6" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="27" y="38" text-anchor="middle" font-size="6" fill="#555" font-weight="bold">1</text>
                                <circle cx="40" cy="35" r="6" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="40" y="38" text-anchor="middle" font-size="6" fill="#555" font-weight="bold">1</text>
                                <circle cx="53" cy="35" r="6" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="53" y="38" text-anchor="middle" font-size="6" fill="#555" font-weight="bold">1</text>
                                <circle cx="66" cy="35" r="6" fill="url(#grad-coin-1)" stroke="#a0a0a0" /><text x="66" y="38" text-anchor="middle" font-size="6" fill="#555" font-weight="bold">1</text>
                            </g>
                        </svg>
                    </div>
                    <div class="visual-guide-item">
                        <span class="visual-guide-text">â‘¢ ã²ã£ç®—ã® ã“ãŸãˆã‚’<br>ã«ã‚…ã†ã‚Šã‚‡ã ã—ã¾ã™</span>
                        <svg viewBox="0 0 120 100">
                            <rect x="15" y="20" width="90" height="70" fill="#fff" stroke="#555" stroke-width="2" />
                            <line x1="45" y1="20" x2="45" y2="90" stroke="#ddd" stroke-width="1" /><line x1="75" y1="20" x2="75" y2="90" stroke="#ddd" stroke-width="1" />
                            <line x1="15" y1="43" x2="105" y2="43" stroke="#ddd" stroke-width="1" /><line x1="15" y1="66" x2="105" y2="66" stroke="#333" stroke-width="2" />
                            <text x="60" y="38" text-anchor="middle" font-size="16" fill="#333">4</text><text x="90" y="38" text-anchor="middle" font-size="16" fill="#333">2</text>
                            <text x="90" y="61" text-anchor="middle" font-size="16" fill="#333">7</text><text x="25" y="61" text-anchor="middle" font-size="16" fill="#333">ãƒ¼</text>
                            
                            <!-- ç­”ãˆã®å…¥åŠ›æ  -->
                            <rect x="47" y="69" width="26" height="20" rx="3" fill="none" stroke="#4da3ff" stroke-width="1.5" />
                            <rect x="77" y="69" width="26" height="20" rx="3" fill="none" stroke="#4da3ff" stroke-width="1.5" />
                            
                            <text x="60" y="84" text-anchor="middle" font-size="16" fill="#4da3ff" font-weight="bold">3</text><text x="90" y="84" text-anchor="middle" font-size="16" fill="#4da3ff" font-weight="bold">5</text>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="start-action-box">
                <button id="start-btn" class="btn">ã‘ã„ã•ã‚“ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            </div>
            
            <footer class="footer-credit">
                <span>&copy;2026 ãã‚Šä¸‹ãŒã‚Šã®ã‚ã‚‹ã²ãç®—ãƒã‚¹ã‚¿ãƒ¼ ï¼©ï¼£ï¼´æ”¯æ´ã®æœ</span>
                <!-- IDç¢ºèªç”¨ -->
                <span id="user-id-footer"></span>
            </footer>
        </div>

        <main class="workspace" id="main-workspace">
            <section class="calc-panel">
                <div class="calc-wrapper">
                    <div id="hissan-grid" class="hissan-grid"></div>
                </div>
                <button id="check-btn" class="btn" style="background-color: var(--accent-color); margin-top: 20px; width: 130px; border-radius: 8px; box-shadow: 0 4px 0 #e65100;">ç­”ãˆåˆã‚ã›</button>
                <div id="message-area" style="margin-top:10px;"></div>
            </section>
            <section class="visual-panel">
                <div class="coin-table mode-coin" id="coin-table">
                    <div class="col-header col-header-hundred">ç™¾ã®ãã‚‰ã„</div>
                    <div class="col-header col-header-ten">åã®ãã‚‰ã„</div>
                    <div class="col-header col-header-one">ä¸€ã®ãã‚‰ã„</div>
                    <!-- ãã‚Šã•ãŒã‚Šæ : ç™¾ã®ä½ã¯æ–‡å­—ã‚’æ¶ˆã—ã¦èƒŒæ™¯ã¯æ®‹ã™ -->
                    <div class="coin-zone col-hundred carry-row" id="zone-carry-100" data-row="carry" data-val="100"></div>
                    <div class="coin-zone carry-row col-ten" id="zone-carry-10" data-row="carry" data-val="10"></div>
                    <div class="coin-zone carry-row col-one" id="zone-carry-1" data-row="carry" data-val="1"></div>
                    
                    <div class="coin-zone col-hundred" id="zone-top-100" data-row="top" data-val="100">
                        <span class="zone-label">ã²ã‹ã‚Œã‚‹ã‹ãš</span>
                        <div class="guide-blink-arrow" id="arrow-top-100">â†“</div>
                        <div class="guide-blink-arrow-up-right" id="arrow-carry-100">â†—</div>
                    </div>
                    <div class="coin-zone col-ten" id="zone-top-10" data-row="top" data-val="10">
                        <span class="zone-label">ã²ã‹ã‚Œã‚‹ã‹ãš</span>
                        <div class="guide-blink-arrow" id="arrow-top-10">â†“</div>
                        <div class="guide-blink-arrow-up-right" id="arrow-carry-10">â†—</div>
                    </div>
                    <div class="coin-zone col-one" id="zone-top-1" data-row="top" data-val="1">
                        <span class="zone-label">ã²ã‹ã‚Œã‚‹ã‹ãš</span>
                        <div class="guide-blink-arrow" id="arrow-top-1">â†“</div>
                    </div>
                    
                    <div class="coin-zone col-hundred" id="zone-mid-100" data-row="mid" data-val="100"><span class="zone-label">ã²ãã‹ãš</span></div>
                    <div class="coin-zone col-ten" id="zone-mid-10" data-row="mid" data-val="10"><span class="zone-label">ã²ãã‹ãš</span></div>
                    <div class="coin-zone col-one" id="zone-mid-1" data-row="mid" data-val="1"><span class="zone-label">ã²ãã‹ãš</span></div>
                    
                    <!-- æ¨ªå¤ªç·šä¸Šã«é…ç½®ã™ã‚‹ãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
                    <div class="drop-down-btn-container" id="dropdown-container" style="display: none;">
                        <button id="dropdown-btn" class="drop-down-btn">ã®ã“ã£ãŸæ•°ã‚’ ãŠã‚ã™ï¼ â†“</button>
                    </div>
                    
                    <div class="coin-zone result-row col-hundred" id="zone-bot-100" data-row="bot" data-val="100"><span class="zone-label">ã“ãŸãˆ</span></div>
                    <div class="coin-zone result-row col-ten" id="zone-bot-10" data-row="bot" data-val="10"><span class="zone-label">ã“ãŸãˆ</span></div>
                    <div class="coin-zone result-row col-one" id="zone-bot-1" data-row="bot" data-val="1"><span class="zone-label">ã“ãŸãˆ</span></div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        const els = {
            workspace: document.getElementById('main-workspace'),
            instruction: document.getElementById('instruction-area'),
            hissanGrid: document.getElementById('hissan-grid'),
            coinTable: document.getElementById('coin-table'),
            checkBtn: document.getElementById('check-btn'),
            msg: document.getElementById('message-area'),
            startBtn: document.getElementById('start-btn'),
            nextBtn: document.getElementById('next-btn'),
            input1: document.getElementById('input1'),
            input2: document.getElementById('input2'),
            headerAns: document.getElementById('header-answer'),
            settingAnswer: document.getElementById('setting-auto-answer'),
            settingAudio: document.getElementById('setting-audio-guide'),
            bigText: document.getElementById('big-text'),
            levelDisplay: document.getElementById('level-display'),
            titleDisplay: document.getElementById('title-display'),
            counterDisplay: document.getElementById('counter-display'),
            masterModal: document.getElementById('master-modal'),
            modalClose: document.getElementById('modal-close-btn'),
            resetBtn: document.getElementById('reset-progress-btn'),
            headerControls: document.getElementById('header-controls'),
            backToHomeBtn: document.getElementById('back-to-home-btn'),
            modeRadios: document.getElementsByName('display-mode-radio'),
            loadingOverlay: document.getElementById('loading-overlay'),
            userIdFooter: document.getElementById('user-id-footer'),
            dropdownBtn: document.getElementById('dropdown-btn'),
            dropdownContainer: document.getElementById('dropdown-container'),
            guideAudioBtn: document.getElementById('guide-audio-btn')
        };

        const apiKey = "";
        let currentAudio = null;
        
        // çŠ¶æ…‹ç®¡ç†
        const state = {
            num1: 0, num2: 0, ans: 0, mode: 'coin', autoAnswer: false, audioGuide: true, questionCount: 0,
            isAnsweredCorrectly: false, audioContextStarted: false, audioCache: {},
            lastPraiseIndex: -1,
            lastGuideTime: 0,
            titles: ["ã²ãã–ã‚“ ã¿ãªã‚‰ã„", "ã²ãã–ã‚“ ã—ã‚…ãã‚‡ã†ã¡ã‚…ã†", "ã²ãã–ã‚“ ã‚ã„ã˜ã‚“", "ã²ãã–ã‚“ ãŸã¤ã˜ã‚“", "ã²ãã–ã‚“ ãŠã†", "ã²ã£ã•ã‚“ã® ã‹ã¿ã•ã¾"],
            isPlaying: false,
            midCounts: { 100: 0, 10: 0, 1: 0 },
            isDroppedDown: false,
            dragging: null,
            borrowFrom10: false,
            borrowFrom100: false,
            idleTimer: null,
            lastSpokenGuide: ""
        };

        // ä¸è¦ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã€ã‚¹ãƒ ãƒ¼ã‚ºã«èª­ã‚ã‚‹ã‚ˆã†ã«èª¿æ•´
        const praises = [
            "ã›ã„ã‹ã„ï¼ãã®ã¡ã‚‡ã†ã—ã ã‚ˆã€‚", 
            "ã™ã”ã„ï¼ã¦ã‚“ã•ã„ã ã­ã€‚", 
            "ã ã„ã›ã„ã‹ã„ï¼ãƒãƒƒãƒãƒªã ã‚ˆã€‚", 
            "ã‚„ã£ãŸã­ï¼ã‹ã£ã“ã„ã„ï¼", 
            "ã™ã”ã™ãã‚‹ã‚ˆï¼ã‹ã‚“ãºãã ã­ã€‚",
            "ãŠã£ï¼ã ã„ã›ã„ã‹ã„ï¼ã™ã”ã„ã™ã”ã„ï¼",
            "ãã®ã¡ã‚‡ã†ã—ï¼ã©ã‚“ã©ã‚“ã„ã“ã†ï¼",
            "ãƒ”ãƒ³ãƒãƒ¼ãƒ³ï¼ã ã„ã›ã„ã‹ã„ï¼",
            "ãŠã‚ã§ã¨ã†ï¼30ã‚‚ã‚“ãŸã£ã›ã„ã ã­ï¼ãã¿ã¯ã‚‚ã†ã€ã‚Šã£ã±ãªã²ãã–ã‚“ãƒã‚¹ã‚¿ãƒ¼ã ã‚ˆï¼ã•ã„ã“ã†ã ã­ï¼", 
            "ã‚ã‚Œã‚Œï¼Ÿã‚‚ã†ã„ã¡ã©ã‹ã‚“ãŒãˆã¦ã¿ã¦ã­ã€‚", 
            "ã¤ãã®ã‚‚ã‚“ã ã„ã‚’ãŠã—ã¦ã­ã€‚"
        ];

        function updateLevelUI() {
            const levelNum = Math.floor(state.questionCount / 5) + 1;
            if (els.levelDisplay) els.levelDisplay.textContent = `ãƒ¬ãƒ™ãƒ«: ${levelNum}`;
            if (els.titleDisplay) els.titleDisplay.textContent = `ã—ã‚‡ã†ã”ã†: ${state.titles[Math.min(Math.floor(state.questionCount / 5), state.titles.length - 1)]}`;
            if (els.counterDisplay) els.counterDisplay.textContent = `${state.questionCount}ï¼30ã‚‚ã‚“`;
        }

        function getCleanStateData() {
            return {
                questionCount: state.questionCount,
                mode: state.mode,
                autoAnswer: state.autoAnswer,
                audioGuide: state.audioGuide,
                isPlaying: state.isPlaying,
                num1: state.num1,
                num2: state.num2,
                ans: state.ans,
                borrowFrom10: state.borrowFrom10,
                borrowFrom100: state.borrowFrom100,
                updatedAt: Date.now() 
            };
        }

        function saveProgress() { 
            try {
                const cleanData = getCleanStateData();
                localStorage.setItem('math-hissan-sub-saveData', JSON.stringify(cleanData));
            } catch(e) { console.error("Save error:", e); }
        }
        
        window.addEventListener('beforeunload', () => {
            saveProgress();
        });

        function loadProgress() { 
            try {
                const savedStr = localStorage.getItem('math-hissan-sub-saveData');
                if (savedStr) { 
                    const data = JSON.parse(savedStr);
                    state.questionCount = data.questionCount || 0; 
                    
                    if (data.mode) {
                        state.mode = data.mode;
                        Array.from(els.modeRadios).forEach(r => r.checked = (r.value === state.mode));
                        if (state.mode === 'coin') {
                            els.coinTable.classList.remove('mode-block');
                            els.coinTable.classList.add('mode-coin');
                        } else {
                            els.coinTable.classList.remove('mode-coin');
                            els.coinTable.classList.add('mode-block');
                        }
                    }
                    
                    if (data.autoAnswer !== undefined) {
                        state.autoAnswer = data.autoAnswer;
                        if (els.settingAnswer) els.settingAnswer.checked = state.autoAnswer;
                    }
                    
                    if (data.audioGuide !== undefined) {
                        state.audioGuide = data.audioGuide;
                        if (els.settingAudio) els.settingAudio.checked = state.audioGuide;
                    }

                    updateLevelUI(); 

                    // é€”ä¸­ã‹ã‚‰ã®å†é–‹ã¯ã€ä¿å­˜ã•ã‚ŒãŸå•é¡Œã®ã€ŒåˆæœŸçŠ¶æ…‹ã€ã‹ã‚‰å†é–‹ã•ã›ã‚‹
                    if (data.isPlaying && data.num1 !== undefined) {
                        state.isPlaying = true;
                        state.num1 = data.num1;
                        state.num2 = data.num2;
                        state.ans = data.ans;
                        if (data.borrowFrom10 !== undefined) state.borrowFrom10 = data.borrowFrom10;
                        if (data.borrowFrom100 !== undefined) state.borrowFrom100 = data.borrowFrom100;
                        
                        els.instruction.style.display = 'none'; 
                        els.workspace.style.display = 'flex'; 
                        els.headerControls.style.display = 'flex'; 
                        els.backToHomeBtn.style.display = 'inline-block';
                        els.startBtn.style.display = 'none'; 
                        els.nextBtn.style.display = 'inline-block'; 
                        
                        els.input1.value = state.num1;
                        els.input2.value = state.num2;
                        els.headerAns.value = "?";
                        els.msg.textContent = "";
                        
                        state.isAnsweredCorrectly = false;
                        
                        initVisuals(); 
                        renderHissan();
                    }
                }
            } catch(e) { console.error("Load error:", e); }
        }

        async function fetchAudioBlob(text) {
            try {
                if (!apiKey) throw new Error("No API Key");
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say cheerfully and clearly with a high-pitched voice to a child in Japanese: ${text}` }] }],
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }
                    })
                });
                if (!response.ok) return null;
                const result = await response.json();
                const base64Data = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (!base64Data) return null;
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
                return new Blob([bytes.buffer], { type: 'audio/wav' });
            } catch (err) { return null; }
        }
        
        async function unlockAudio() {
            if (state.audioContextStarted) return;
            const audioCtxInternal = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtxInternal.state === 'suspended') await audioCtxInternal.resume();
            state.audioContextStarted = true;
            if (apiKey) {
                for (const text of praises) { if (!state.audioCache[text]) { const blob = await fetchAudioBlob(text); if (blob) state.audioCache[text] = URL.createObjectURL(blob); } }
            }
        }
        
        // force ãŒ true ã®å ´åˆã¯ã€è¨­å®šãŒOFFã§ã‚‚å¼·åˆ¶çš„ã«å†ç”Ÿã™ã‚‹ï¼ˆèª¬æ˜ãƒœã‚¿ãƒ³ç”¨ï¼‰
        async function speak(text, force = false) {
            if (!state.audioGuide && !force) return;
            
            if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; currentAudio = null; }
            if ('speechSynthesis' in window) window.speechSynthesis.cancel();
            if (!state.audioContextStarted) await unlockAudio();
            if (state.audioCache[text]) { const audio = new Audio(state.audioCache[text]); currentAudio = audio; audio.play().catch(e => console.error(e)); return; }
            if (apiKey) { try { const blob = await fetchAudioBlob(text); if (blob) { const url = URL.createObjectURL(blob); state.audioCache[text] = url; const audio = new Audio(url); currentAudio = audio; audio.play().catch(e => console.error(e)); return; } } catch(e) { } }
            if ('speechSynthesis' in window) {
                const uttr = new SpeechSynthesisUtterance(text);
                uttr.lang = 'ja-JP';
                const voices = window.speechSynthesis.getVoices();
                const bestVoice = voices.find(v => v.name.includes('Google') && v.lang.includes('ja')) || voices.find(v => v.lang.includes('ja'));
                if (bestVoice) uttr.voice = bestVoice;
                uttr.rate = 1.0; uttr.pitch = 1.6; uttr.volume = 1.0;
                window.speechSynthesis.speak(uttr);
            }
        }

        function resetProgress() { 
            state.questionCount = 0; 
            state.isAnsweredCorrectly = false; 
            updateLevelUI(); 
            generateNextProblem(); 
        }

        function clearIdleTimer() {
            if (state.idleTimer) {
                clearTimeout(state.idleTimer);
                state.idleTimer = null;
            }
        }

        // èµ¤ã„ç‚¹æ»…æ ã‚’ã™ã¹ã¦æ¶ˆã™é–¢æ•°
        function clearErrorHighlights() {
            document.querySelectorAll('.joined-highlight').forEach(el => el.remove());
        }
        
        // ã²ã‹ã‚Œã‚‹æ•°ã¨ã²ãæ•°ã®2ã¤ã®æ ã‚’ã¾ã¨ã‚ã¦1ã¤ã®é•·æ–¹å½¢ã§å›²ã‚€é–¢æ•°
        function drawHighlight(containerId, topId, midId) {
            const container = document.getElementById(containerId);
            const topEl = document.getElementById(topId);
            const midEl = document.getElementById(midId);
            
            if (!container || !topEl || !midEl) return;
            
            const containerRect = container.getBoundingClientRect();
            const topRect = topEl.getBoundingClientRect();
            const midRect = midEl.getBoundingClientRect();
            
            const highlight = document.createElement('div');
            highlight.className = 'joined-highlight';
            
            // ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã®ç›¸å¯¾åº§æ¨™ã‚’è¨ˆç®—ã—ã¦ã€2ã¤ã®æ ã‚’åŒ…ã¿è¾¼ã‚€1ã¤ã®é•·æ–¹å½¢ã‚’ä½œã‚‹
            const t = topRect.top - containerRect.top;
            const l = topRect.left - containerRect.left;
            const w = topRect.width;
            const h = midRect.bottom - topRect.top;
            
            // ç·šãŒè¦‹åˆ‡ã‚Œãªã„ã‚ˆã†ã«å°‘ã—ã ã‘å†…å´ã«é…ç½®
            highlight.style.top = (t + 2) + 'px';
            highlight.style.left = (l + 2) + 'px';
            highlight.style.width = (w - 4) + 'px';
            highlight.style.height = (h - 4) + 'px';
            
            container.appendChild(highlight);
        }

        function resetIdleTimer() {
            clearIdleTimer();
            // ã‚²ãƒ¼ãƒ ä¸­ã‹ã¤æ­£è§£æ¸ˆã¿ã§ãªã„å ´åˆã®ã¿30ç§’ã‚¿ã‚¤ãƒãƒ¼ã‚»ãƒƒãƒˆ
            if (state.isPlaying && !state.isAnsweredCorrectly && !state.isDroppedDown) {
                state.idleTimer = setTimeout(() => {
                    updateGuide(true);
                }, 30000);
            }
        }

        // å¼•æ•°ã« silent (éŸ³å£°ã‚’é³´ã‚‰ã•ãªã„ãƒ•ãƒ©ã‚°) ã‚’è¿½åŠ 
        function updateGuide(speakInstruction = false, silent = false) {
            if (state.isDroppedDown) {
                hideGuideArrows();
                return;
            }
            
            // å¿…è¦ãªæ•°ã®å€¤
            const req100 = Math.floor(state.num2 / 100) * 100;
            const req10 = Math.floor((state.num2 % 100) / 10) * 10;
            const req1 = state.num2 % 10;
            
            // ä¸‹ã«ç§»å‹•ã—ãŸæ•°ã®åˆè¨ˆå€¤
            const mid100 = state.midCounts[100] || 0;
            const mid10 = state.midCounts[10] || 0;
            const mid1 = state.midCounts[1] || 0;
            
            // ã¾ã ä¸‹ã«ç§»å‹•ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚‹å€¤
            const needBot100 = req100 - mid100;
            const needBot10 = req10 - mid10;
            const needBot1 = req1 - mid1;
            
            // ç”»é¢ä¸Šã«ã‚ã‚‹åˆ©ç”¨å¯èƒ½ãªï¼ˆä½¿ã‚ã‚Œã¦ã„ãªã„ï¼‰ãŠé‡‘ã®æ•°ã‚’è¨ˆç®—
            const getCurCount = (baseVal) => {
                let sum = 0;
                const elements = document.querySelectorAll(`.coin-zone[data-row="top"][data-val="${baseVal}"] .token:not(.used):not(.ghost), .coin-zone[data-row="carry"][data-val="${baseVal}"] .token:not(.used):not(.ghost)`);
                elements.forEach(t => {
                    if (t && t.dataset && t.dataset.val) {
                        sum += parseInt(t.dataset.val);
                    }
                });
                return sum;
            };

            const cur100 = getCurCount(100);
            const cur10 = getCurCount(10);
            const cur1 = getCurCount(1);
            
            hideGuideArrows();
            clearErrorHighlights(); // ã‚¬ã‚¤ãƒ‰æ›´æ–°å‰ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ

            if (needBot100 === 0 && needBot10 === 0 && needBot1 === 0) {
                return;
            }

            const itemText = state.mode === 'block' ? 'ãƒ–ãƒ­ãƒƒã‚¯' : 'ãŠã‹ã­';
            let msg = "";
            const kana = ["ãœã‚", "ã„ã¡", "ã«", "ã•ã‚“", "ã‚ˆã‚“", "ã”", "ã‚ã", "ãªãª", "ã¯ã¡", "ãã‚…ã†"];

            // ä¸‹ã®ä½ã‹ã‚‰é †ç•ªã«ã‚¬ã‚¤ãƒ‰ã‚’è¡Œã†
            if (needBot1 > 0) {
                if (cur1 < needBot1) {
                    document.getElementById('arrow-carry-10')?.style.setProperty('display', 'block');
                    const start1 = (cur1 + mid1);
                    const req1_val = state.num2 % 10;
                    const s1 = kana[start1] || start1;
                    const r1 = kana[req1_val] || req1_val;
                    // èª­ç‚¹ã‚’æ¸›ã‚‰ã—ã¦ã‚¹ãƒ ãƒ¼ã‚ºã«
                    msg = `${s1}ã‹ã‚‰ã€${r1}ã¯ã²ã‘ãªã„ã‹ã‚‰ã€åã®ãã‚‰ã„ã‹ã‚‰ãã‚Šã•ã’ã‚‹ã‚ˆã€‚`;

                    // ä¸€ã®ä½ã®ç­†ç®—ã¨ã‚³ã‚¤ãƒ³ã®æ ã‚’ã€ãã‚Œãã‚Œ1ã¤ã®é•·æ–¹å½¢ã§èµ¤ãç‚¹æ»…ã•ã›ã‚‹
                    drawHighlight('hissan-grid', 'hissan-top-1', 'hissan-mid-1');
                    drawHighlight('coin-table', 'zone-top-1', 'zone-mid-1');
                } else {
                    document.getElementById('arrow-top-1')?.style.setProperty('display', 'block');
                    if (speakInstruction) msg = `${itemText}ã‚’ã€ã²ãã‹ãšã®ã¶ã‚“ã ã‘ã—ãŸã«ãŠã‚ãã†ã€‚`;
                }
            } else if (needBot10 > 0) {
                if (cur10 < needBot10) {
                    document.getElementById('arrow-carry-100')?.style.setProperty('display', 'block');
                    const start10 = (cur10 + mid10) / 10;
                    const req10_val = Math.floor((state.num2 % 100) / 10);
                    const s10 = kana[start10] || start10;
                    const r10 = kana[req10_val] || req10_val;
                    // èª­ç‚¹ã‚’æ¸›ã‚‰ã—ã¦ã‚¹ãƒ ãƒ¼ã‚ºã«
                    msg = `${s10}ã‹ã‚‰ã€${r10}ã¯ã²ã‘ãªã„ã‹ã‚‰ã€ç™¾ã®ãã‚‰ã„ã‹ã‚‰ãã‚Šã•ã’ã‚‹ã‚ˆã€‚`;

                    // åã®ä½ã®ç­†ç®—ã¨ã‚³ã‚¤ãƒ³ã®æ ã‚’ã€ãã‚Œãã‚Œ1ã¤ã®é•·æ–¹å½¢ã§èµ¤ãç‚¹æ»…ã•ã›ã‚‹
                    drawHighlight('hissan-grid', 'hissan-top-10', 'hissan-mid-10');
                    drawHighlight('coin-table', 'zone-top-10', 'zone-mid-10');
                } else {
                    document.getElementById('arrow-top-10')?.style.setProperty('display', 'block');
                    if (speakInstruction) msg = `${itemText}ã‚’ã€ã²ãã‹ãšã®ã¶ã‚“ã ã‘ã—ãŸã«ãŠã‚ãã†ã€‚`;
                }
            } else if (needBot100 > 0) {
                document.getElementById('arrow-top-100')?.style.setProperty('display', 'block');
                if (speakInstruction) msg = `${itemText}ã‚’ã€ã²ãã‹ãšã®ã¶ã‚“ã ã‘ã—ãŸã«ãŠã‚ãã†ã€‚`;
            }

            if (msg !== "" && !silent) {
                // å¼·åˆ¶èª­ã¿ä¸Šã’ã‹ã€å‰å›ã¨é•ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã®ã¿å–‹ã‚‹
                if (speakInstruction || state.lastSpokenGuide !== msg) {
                    speak(msg);
                    state.lastSpokenGuide = msg;
                }
            }
        }

        function hideGuideArrows() {
            document.querySelectorAll('.guide-blink-arrow, .guide-blink-arrow-up-right').forEach(el => {
                if (el && el.style) el.style.display = 'none';
            });
        }

        function initVisuals() {
            // å…¨ã‚¾ãƒ¼ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆçŸ¢å°ã‚¬ã‚¤ãƒ‰ã¯æ®‹ã™ã‚ˆã†ã«åˆ¶å¾¡ï¼‰
            document.querySelectorAll('.coin-zone').forEach(el => {
                Array.from(el.childNodes).forEach(c => { 
                    if(c && c.nodeType === 1) { // Element Node
                        if(!c.classList.contains('zone-label') && 
                           !c.classList.contains('guide-blink-arrow') && 
                           !c.classList.contains('guide-blink-arrow-up-right') &&
                           !c.classList.contains('drop-down-btn')) {
                            c.remove(); 
                        }
                    }
                });
            });
            
            clearErrorHighlights(); // åˆæœŸåŒ–æ™‚ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ¶ˆã™

            state.midCounts = { 100: 0, 10: 0, 1: 0 };
            state.isDroppedDown = false;
            if (els.dropdownContainer) els.dropdownContainer.style.display = 'none';
            
            const d1 = { 
                100: Math.floor(state.num1 / 100), 
                10: Math.floor((state.num1 % 100) / 10), 
                1: state.num1 % 10 
            };
            
            // top ã« num1 ã‚’é…ç½®
            ['100', '10', '1'].forEach(baseStr => {
                const baseVal = parseInt(baseStr);
                const count = d1[baseVal];
                if (count > 0) {
                    const zone = document.getElementById(`zone-top-${baseVal}`);
                    if (zone) {
                        const container = document.createElement('div');
                        container.className = `token-container ${state.mode === 'block' && baseVal===10 ? 'container-ten' : 'container-grid'}`;
                        
                        if (state.mode === 'block' && baseVal === 1) {
                            let rem = count;
                            while(rem >= 5) { container.appendChild(createToken(5, baseVal, true)); rem -= 5; }
                            while(rem > 0) { container.appendChild(createToken(1, baseVal, true)); rem--; }
                        } else {
                            for(let i=0; i<count; i++) container.appendChild(createToken(baseVal, baseVal, true));
                        }
                        zone.appendChild(container);
                    }
                }
            });

            checkMidComplete(); 
            if (!state.isDroppedDown) {
                updateGuide(false, true); // åˆæœŸåŒ–ã®ç¬é–“ã¯éŸ³ã‚’å‡ºã•ãªã„ï¼ˆäºŒé‡ç™ºå£°é˜²æ­¢ï¼‰
            } else {
                hideGuideArrows();
            }
        }

        function createToken(val, baseVal, isDraggable) {
            const el = document.createElement('div'); 
            el.className = `token ${state.mode}-${val} ${state.mode}`;
            if (state.mode === 'coin') el.classList.add(`coin-${val}`);
            if (state.mode === 'coin') el.textContent = val;
            
            el.dataset.val = val;
            el.dataset.baseVal = baseVal;
            
            if (isDraggable) {
                el.addEventListener('mousedown', onDragStart);
                el.addEventListener('touchstart', onDragStart, {passive: false});
            } else {
                el.style.pointerEvents = 'none';
            }
            return el;
        }

        function onDragStart(e) {
            const el = e.currentTarget;
            if (el.classList.contains('ghost') || el.classList.contains('used')) return; 
            
            resetIdleTimer();
            clearErrorHighlights(); // å‹•ã‹ã—å§‹ã‚ãŸã‚‰èµ¤ã„ç‚¹æ»…ã‚’æ¶ˆã™

            e.preventDefault(); unlockAudio();
            
            const cx = e.touches ? e.touches[0].clientX : e.clientX; 
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            const rect = el.getBoundingClientRect(); 
            const proxy = el.cloneNode(true);
            
            proxy.style.position = 'fixed'; 
            proxy.style.left = rect.left + 'px'; 
            proxy.style.top = rect.top + 'px';
            proxy.style.width = rect.width + 'px'; 
            proxy.style.height = rect.height + 'px';
            proxy.style.zIndex = 2000; 
            proxy.style.pointerEvents = 'none'; 
            proxy.style.opacity = '1.0';
            
            document.body.appendChild(proxy); 
            
            // å…ƒè¦ç´ ã¯éè¡¨ç¤ºã«
            if (el && el.style) el.style.visibility = 'hidden';
            
            state.dragging = { 
                el, 
                proxy, 
                val: parseInt(el.dataset.val), 
                baseVal: parseInt(el.dataset.baseVal),
                offsetX: cx - rect.left, 
                offsetY: cy - rect.top 
            };
        }
        
        function onDragMove(e) { 
            if (!state.dragging) return; 
            e.preventDefault(); 
            const cx = e.touches ? e.touches[0].clientX : e.clientX; 
            const cy = e.touches ? e.touches[0].clientY : e.clientY; 
            state.dragging.proxy.style.left = (cx - state.dragging.offsetX) + 'px'; 
            state.dragging.proxy.style.top = (cy - state.dragging.offsetY) + 'px'; 
        }
        
        function onDragEnd(e) {
            if (!state.dragging) return; 
            const { el, proxy, val, baseVal } = state.dragging;
            const cx = e.changedTouches ? e.changedTouches[0].clientX : e.clientX; 
            const cy = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            
            proxy.remove(); 
            const targetZone = document.elementFromPoint(cx, cy)?.closest('.coin-zone');
            let success = false;
            
            if (targetZone) {
                const targetRow = targetZone.dataset.row;
                const targetBase = parseInt(targetZone.dataset.val);
                
                if (targetRow === 'carry') {
                    // ä¸¡æ›¿ (100 -> 10, or 10 -> 1)
                    if (baseVal === targetBase * 10 && baseVal === val) {
                        performRegroup(el, targetZone, targetBase);
                        success = true;
                    }
                } else if (targetRow === 'mid') {
                    // å¼•ãç®—
                    if (baseVal === targetBase) {
                        const currentMidCount = state.midCounts[baseVal] || 0;
                        
                        // ã²ãæ•°ã®ä¸Šé™ã‚’è¨­å®š
                        let reqVal = 0;
                        if (baseVal === 100) reqVal = Math.floor(state.num2 / 100) * 100;
                        if (baseVal === 10) reqVal = Math.floor((state.num2 % 100) / 10) * 10;
                        if (baseVal === 1) reqVal = state.num2 % 10;
                        
                        if (currentMidCount + val <= reqVal) {
                            performSubtract(el, targetZone, baseVal, val);
                            success = true;
                        } else {
                            speak("ã²ãã‹ãš ã‚ˆã‚Š å¤šããªã£ã¡ã‚ƒã†ã‚ˆï¼");
                        }
                    }
                }
            }
            
            if (!success) {
                if (el && el.style) el.style.visibility = 'visible'; // æˆ»ã™
            }
            
            state.dragging = null;
        }

        function performRegroup(sourceEl, targetZone, targetBase) {
            sourceEl.remove(); // å…ƒã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯å‰Šé™¤
            
            let container = targetZone.querySelector('.token-container');
            if (!container) {
                container = document.createElement('div');
                container.className = `token-container ${state.mode === 'block' && targetBase===10 ? 'container-ten' : 'container-grid'}`;
                targetZone.appendChild(container);
            }
            
            if (state.mode === 'block' && targetBase === 1) {
                container.appendChild(createToken(5, 1, true));
                for(let i=0; i<5; i++) container.appendChild(createToken(1, 1, true));
            } else {
                for(let i=0; i<10; i++) container.appendChild(createToken(targetBase, targetBase, true));
            }
            
            if (targetBase === 10) {
                state.borrowFrom100 = true;
            } else if (targetBase === 1) {
                state.borrowFrom10 = true;
            }

            renderHissan();
            saveProgress();
            
            speak("ãã‚Šã•ã’ãŸã‚ˆã€‚");
            
            // ã€Œãã‚Šã•ã’ãŸã‚ˆã€‚ã€ã®éŸ³å£°ãŒé³´ã‚Šçµ‚ã‚ã‚‹é ƒã«ã€æ¬¡ã®æŒ‡ç¤ºã¨çŸ¢å°ã‚’å‡ºã™
            setTimeout(() => {
                updateGuide(true);
                resetIdleTimer();
            }, 1200);
        }

        function performSubtract(sourceEl, targetZone, baseVal, val) {
            // å…ƒãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€éçŠ¶æ…‹ï¼ˆusedï¼‰ã«ã—ã¦æ®‹ã™
            if (sourceEl && sourceEl.style) sourceEl.style.visibility = 'visible';
            if (sourceEl && sourceEl.classList) sourceEl.classList.add('used');
            
            let container = targetZone.querySelector('.token-container');
            if (!container) {
                container = document.createElement('div');
                container.className = `token-container ${state.mode === 'block' && baseVal===10 ? 'container-ten' : 'container-grid'}`;
                targetZone.appendChild(container);
            }
            
            const newToken = createToken(val, baseVal, false); // ã²ãã‹ãšã‚¾ãƒ¼ãƒ³ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ‰ãƒ©ãƒƒã‚°ä¸å¯
            container.appendChild(newToken);
            
            if (!state.midCounts[baseVal]) state.midCounts[baseVal] = 0;
            state.midCounts[baseVal] += val;
            
            saveProgress();
            checkMidComplete();
            updateGuide(false);
            
            // ä¸‹ã‚ã™ãŸã³ã«ç­†ç®—ã®ç­”ãˆæ ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã™ã‚‹
            syncHissanWithBot();
        }

        function checkMidComplete() {
            if (state.isDroppedDown) return;
            
            const req100 = Math.floor(state.num2 / 100) * 100;
            const req10 = Math.floor((state.num2 % 100) / 10) * 10;
            const req1 = state.num2 % 10;
            
            const mid100 = state.midCounts[100] || 0;
            const mid10 = state.midCounts[10] || 0;
            const mid1 = state.midCounts[1] || 0;
            
            if (mid100 === req100 && mid10 === req10 && mid1 === req1) {
                if (els.dropdownContainer && els.dropdownContainer.style) {
                    if (els.dropdownContainer.style.display !== 'flex') {
                        els.dropdownContainer.style.display = 'flex';
                        speak("ãƒœã‚¿ãƒ³ã‚’ãŠã—ã¦ã€ã®ã“ã£ãŸã‹ãšã‚’ã€ãŠã‚ã—ã¾ã™ã€‚");
                    }
                }
            } else {
                if (els.dropdownContainer && els.dropdownContainer.style) els.dropdownContainer.style.display = 'none';
            }
        }

        if (els.dropdownBtn) {
            els.dropdownBtn.addEventListener('click', () => {
                if (state.isDroppedDown) return;
                
                clearIdleTimer();
                
                if (els.dropdownContainer && els.dropdownContainer.style) els.dropdownContainer.style.display = 'none';
                state.isDroppedDown = true;
                hideGuideArrows();
                
                const tokensToMove = document.querySelectorAll('.coin-zone[data-row="top"] .token:not(.used):not(.ghost), .coin-zone[data-row="carry"] .token:not(.used):not(.ghost)');
                
                if (tokensToMove.length === 0) {
                    syncHissanWithBot();
                    return;
                }

                // FLIP Animation
                const firstRects = Array.from(tokensToMove).map(t => {
                    const rect = t.getBoundingClientRect();
                    const clone = t.cloneNode(true);
                    clone.classList.add('used');
                    clone.style.pointerEvents = 'none';
                    if (t.parentNode) t.parentNode.insertBefore(clone, t);
                    return rect;
                });
                
                tokensToMove.forEach(t => {
                    const baseVal = t.dataset.baseVal;
                    const targetBotZone = document.getElementById(`zone-bot-${baseVal}`);
                    if (targetBotZone) {
                        let container = targetBotZone.querySelector('.token-container');
                        if (!container) {
                            container = document.createElement('div');
                            container.className = `token-container ${state.mode === 'block' && baseVal==='10' ? 'container-ten' : 'container-grid'}`;
                            targetBotZone.appendChild(container);
                        }
                        container.appendChild(t);
                        t.style.pointerEvents = 'none';
                    }
                });

                tokensToMove.forEach((t, i) => {
                    const first = firstRects[i];
                    const last = t.getBoundingClientRect();
                    const dx = first.left - last.left;
                    const dy = first.top - last.top;
                    
                    t.style.transform = `translate(${dx}px, ${dy}px)`;
                    t.style.transition = 'none';
                    
                    requestAnimationFrame(() => {
                        t.style.transform = '';
                        t.style.transition = 'transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)'; 
                    });
                });

                speak("ã®ã“ã£ãŸã‹ãšãŒã€ã“ãŸãˆã ã‚ˆã€‚");

                setTimeout(() => {
                    syncHissanWithBot();
                }, 600);
            });
        }

        function syncHissanWithBot() {
            if (!els.settingAnswer || !els.settingAnswer.checked) return; 
            
            let botSum = { 100: 0, 10: 0, 1: 0 };
            
            ['100', '10', '1'].forEach(baseStr => {
                const baseVal = parseInt(baseStr);
                const zone = document.getElementById(`zone-bot-${baseVal}`);
                if (zone) {
                    const tokens = zone.querySelectorAll('.token');
                    let sum = 0;
                    tokens.forEach(t => { 
                        if (t && t.dataset && t.dataset.val) sum += parseInt(t.dataset.val); 
                    });
                    botSum[baseVal] = sum;
                }
            });

            if (document.getElementById('ans-1')) {
                document.getElementById('ans-1').value = botSum[1];
            }
            if (document.getElementById('ans-10')) {
                document.getElementById('ans-10').value = (botSum[10] > 0 || botSum[100] > 0) ? Math.floor(botSum[10] / 10) : "";
            }
            if (document.getElementById('ans-100')) {
                document.getElementById('ans-100').value = botSum[100] > 0 ? Math.floor(botSum[100] / 100) : "";
            }
        }

        function renderHissan() {
            if (!els.hissanGrid) return;
            els.hissanGrid.innerHTML = "";
            
            const is3Digit = state.num1 >= 100;
            const cols = is3Digit ? 4 : 3;
            
            els.hissanGrid.className = `hissan-grid cols-${cols}`;
            
            const d1 = { 100: Math.floor(state.num1 / 100), 10: Math.floor((state.num1 % 100) / 10), 1: state.num1 % 10 };
            const d2 = { 100: Math.floor(state.num2 / 100), 10: Math.floor((state.num2 % 100) / 10), 1: state.num2 % 10 };
            
            let carryVals = [];
            if (is3Digit) {
                carryVals.push({ text: "", active: false });
                carryVals.push({ text: state.borrowFrom100 ? (d1[100] - 1) : "", active: state.borrowFrom100 });
                carryVals.push({ text: state.borrowFrom100 ? "10" : (state.borrowFrom10 ? (d1[10] - 1) : ""), active: state.borrowFrom100 || state.borrowFrom10 });
                carryVals.push({ text: state.borrowFrom10 ? "10" : "", active: state.borrowFrom10 });
            } else {
                carryVals.push({ text: "", active: false });
                carryVals.push({ text: state.borrowFrom10 ? (d1[10] - 1) : "", active: state.borrowFrom10 });
                carryVals.push({ text: state.borrowFrom10 ? "10" : "", active: state.borrowFrom10 });
            }

            carryVals.forEach(c => {
                const cell = document.createElement('div');
                cell.className = 'hissan-cell hissan-carry-cell';
                if (c.active) cell.classList.add('active');
                cell.textContent = c.text;
                els.hissanGrid.appendChild(cell);
            });

            // è¡Œ1: ã²ã‹ã‚Œã‚‹æ•°ï¼ˆæ–œç·šå¯¾å¿œã¨IDä»˜ä¸ï¼‰
            let topVals = [];
            if (is3Digit) {
                topVals.push({ val: "", strike: false, id: null });
                topVals.push({ val: d1[100], strike: state.borrowFrom100, id: 'hissan-top-100' });
                topVals.push({ val: d1[10], strike: state.borrowFrom10, id: 'hissan-top-10' });
                topVals.push({ val: d1[1], strike: false, id: 'hissan-top-1' });
            } else {
                topVals.push({ val: "", strike: false, id: null });
                topVals.push({ val: d1[10], strike: state.borrowFrom10, id: 'hissan-top-10' });
                topVals.push({ val: d1[1], strike: false, id: 'hissan-top-1' });
            }

            topVals.forEach((t) => {
                const cell = document.createElement('div');
                cell.className = 'hissan-cell';
                if (t.id) cell.id = t.id; // ç‚¹æ»…ã•ã›ã‚‹ãŸã‚ã®IDã‚’ã‚»ãƒƒãƒˆ
                if (t.strike) cell.classList.add('strike-through');
                cell.textContent = t.val; 
                els.hissanGrid.appendChild(cell);
            });
            
            // è¡Œ2: ã²ãæ•°ï¼ˆIDä»˜ä¸ï¼‰
            let midVals = [];
            if (is3Digit) {
                midVals.push({ val: "ãƒ¼", isOp: true, id: null });
                midVals.push({ val: d2[100] || "", isOp: false, id: 'hissan-mid-100' });
                midVals.push({ val: d2[10] || "", isOp: false, id: 'hissan-mid-10' });
                midVals.push({ val: d2[1], isOp: false, id: 'hissan-mid-1' });
            } else {
                midVals.push({ val: "ãƒ¼", isOp: true, id: null });
                midVals.push({ val: d2[10] || "", isOp: false, id: 'hissan-mid-10' });
                midVals.push({ val: d2[1], isOp: false, id: 'hissan-mid-1' });
            }

            midVals.forEach((m) => {
                const cell = document.createElement('div');
                cell.className = 'hissan-cell hissan-bottom-line';
                if (m.id) cell.id = m.id; // ç‚¹æ»…ã•ã›ã‚‹ãŸã‚ã®IDã‚’ã‚»ãƒƒãƒˆ
                if (m.isOp) {
                    const op = document.createElement('span');
                    op.className = 'operator';
                    op.textContent = m.val;
                    cell.appendChild(op);
                } else {
                    cell.textContent = m.val; 
                }
                els.hissanGrid.appendChild(cell);
            });
            
            let botIds = [];
            if (is3Digit) {
                botIds.push(null);
                botIds.push('ans-100');
                botIds.push('ans-10');
                botIds.push('ans-1');
            } else {
                botIds.push(null);
                botIds.push('ans-10');
                botIds.push('ans-1');
            }

            botIds.forEach(id => {
                const cell = document.createElement('div');
                cell.className = 'hissan-cell';
                if (id) {
                    const inp = document.createElement('input');
                    inp.id = id;
                    inp.className = 'hissan-input';
                    inp.inputMode = 'numeric';
                    inp.oninput = (e) => e.target.value = e.target.value.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/[^0-9]/g, '');
                    cell.appendChild(inp);
                }
                els.hissanGrid.appendChild(cell);
            });
            
            syncHissanWithBot();
        }

        function generateNextProblem() {
            state.isAnsweredCorrectly = false; 
            state.borrowFrom10 = false;
            state.borrowFrom100 = false;
            let n1, n2; const count = state.questionCount + 1;
            
            const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

            if (count <= 5) { 
                let t1 = rand(2, 5);
                let u2 = rand(1, 8);
                let randU1 = rand(u2 + 1, 9);
                n1 = t1 * 10 + randU1;
                n2 = u2;
            } 
            else if (count <= 10) { 
                let t1 = rand(2, 9);
                let randU1 = rand(0, 8);
                let u2 = rand(randU1 + 1, 9);
                n1 = t1 * 10 + randU1;
                n2 = u2;
            } 
            else if (count <= 20) { 
                let t2 = rand(1, 8);
                let t1 = rand(t2 + 1, 9);
                let randU1 = rand(0, 8);
                let u2 = rand(randU1 + 1, 9);
                n1 = t1 * 10 + randU1;
                n2 = t2 * 10 + u2;
            } 
            else if (count <= 25) { 
                let h1 = rand(1, 9);
                let t2 = rand(1, 7);
                let t1 = rand(t2 + 1, 9);
                let randU1 = rand(0, 8);
                let u2 = rand(randU1 + 1, 9); 
                n1 = h1 * 100 + t1 * 10 + randU1;
                n2 = t2 * 10 + u2;
            }
            else { 
                let h1 = rand(1, 9);
                let randU1 = rand(0, 8);
                let u2 = rand(randU1 + 1, 9); 
                let t2 = rand(1, 9);
                let t1 = rand(0, t2);     
                n1 = h1 * 100 + t1 * 10 + randU1;
                n2 = t2 * 10 + u2;
            }
            
            state.num1 = n1; state.num2 = n2; state.ans = n1 - n2; 
            
            if (els.input1) els.input1.value = n1; 
            if (els.input2) els.input2.value = n2; 
            
            state.lastSpokenGuide = ""; // å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
            
            initVisuals(); 
            renderHissan(); 
            saveProgress();
            
            if (els.headerAns) els.headerAns.value = "?"; 
            if (els.msg) els.msg.textContent = "";

            setTimeout(() => {
                if (state.questionCount === 0) {
                    updateGuide(true);
                } else {
                    updateGuide(false);
                    resetIdleTimer();
                }
            }, 800);
        }
        
        function checkAnswer() {
            clearIdleTimer();
            // æ—¢ã«æ­£è§£ã—ã¦ã„ã‚‹å ´åˆã«ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®æ¡ˆå†…ï¼ˆå¼·åˆ¶å†ç”Ÿï¼‰
            if (state.isAnsweredCorrectly) { if (Date.now() - state.lastGuideTime < 3000) return; state.lastGuideTime = Date.now(); speak(praises[10], true); return; }
            const u100 = parseInt(document.getElementById('ans-100')?.value) || 0; const u10 = parseInt(document.getElementById('ans-10')?.value) || 0; const u1 = parseInt(document.getElementById('ans-1')?.value) || 0;
            if (u100 * 100 + u10 * 10 + u1 === state.ans) {
                state.isAnsweredCorrectly = true;
                state.questionCount++; 
                saveProgress(); 
                updateLevelUI(); 
                
                // æ­£è§£æ™‚ã€ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ™‚ã€ã‚¯ãƒªã‚¢æ™‚ã®éŸ³å£°ã¯å¼·åˆ¶çš„ã«é³´ã‚‰ã™ï¼ˆç¬¬2å¼•æ•°ã« true ã‚’è¨­å®šï¼‰
                if (state.questionCount === 30) speak(praises[8], true);
                else if (state.questionCount % 5 === 0) speak(`ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ã—ã‚‡ã†ã”ã†ãŒã€${state.titles[Math.min(Math.floor(state.questionCount / 5), state.titles.length - 1)]}ã«ãªã£ãŸã‚ˆï¼ãŠã‚ã§ã¨ã†ï¼`, true);
                else { 
                    let pIdx; do { pIdx = Math.floor(Math.random() * 8); } while (pIdx === state.lastPraiseIndex);
                    state.lastPraiseIndex = pIdx; speak(praises[pIdx], true);
                }
                
                if (els.bigText) {
                    els.bigText.classList.add('show'); 
                    setTimeout(() => els.bigText.classList.remove('show'), 2000);
                }
                for(let i=0; i<100; i++){ const p = document.createElement('div'); p.className='confetti-piece'; p.style.left = Math.random() * 100 + 'vw'; p.style.backgroundColor = ['#f44336','#e91e63','#9c27b0','#673ab7','#3f51b5','#2196f3','#03a9f4','#00bcd4','#009688','#4caf50','#8bc34a','#cddc39','#ffeb3b','#ffc107','#ff9800','#ff5722'][Math.floor(Math.random()*16)]; p.style.animationDuration = (Math.random() * 3 + 2) + 's'; p.style.animationDelay = (Math.random() * 2) + 's'; document.body.appendChild(p); setTimeout(()=>p.remove(), 5000); }
                if (els.headerAns) els.headerAns.value = state.ans; 
                if (state.questionCount === 30) setTimeout(() => { if(els.masterModal) els.masterModal.style.display = 'flex'; }, 500);
            } else { 
                speak(praises[9]); // ä¸æ­£è§£æ™‚ã®ãƒ’ãƒ³ãƒˆã¯è¨­å®šã«å¾“ã†
            }
        }

        const initApp = () => {
            const hideLoading = () => {
                if (els.loadingOverlay && els.loadingOverlay.style.display !== 'none') {
                    els.loadingOverlay.style.opacity = '0';
                    setTimeout(() => els.loadingOverlay.style.display = 'none', 300);
                }
            };

            try {
                if(els.userIdFooter) {
                    els.userIdFooter.textContent = 'ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ¢ãƒ¼ãƒ‰';
                }
                loadProgress(); 
            } catch(e) { 
                console.error("Init error:", e); 
            } finally {
                hideLoading();
            }
        };
        
        // æœ€åˆã®ç”»é¢ã®éŸ³å£°ã‚¬ã‚¤ãƒ‰ãƒœã‚¿ãƒ³ã®å‡¦ç†ã‚’è¿½åŠ 
        if (els.guideAudioBtn) {
            let guideTimeoutIds = [];
            els.guideAudioBtn.addEventListener('click', async () => {
                await unlockAudio();
                // èª¬æ˜ãƒœã‚¿ãƒ³ã¯ force=true ã‚’æ¸¡ã—ã¦å¼·åˆ¶çš„ã«éŸ³ã‚’é³´ã‚‰ã™
                speak("ãã‚Šã•ãŒã‚Šã®ã‚ã‚‹ã²ãã–ã‚“ã‚’ã€ãƒã‚¹ã‚¿ãƒ¼ã—ã‚ˆã†ï¼ãƒ¢ãƒ¼ãƒ‰ã‚’ãˆã‚‰ã‚“ã ã‚‰ã€ã“ãŸãˆã˜ã©ã†ã®ãƒã‚§ãƒƒã‚¯ã‚‚ã‹ãã«ã‚“ã—ã¦ã€ã‘ã„ã•ã‚“ã‚¹ã‚¿ãƒ¼ãƒˆã‚’ãŠã—ã¦ã­ã€‚ã²ãã–ã‚“ã®ã¨ãã¯ã€ã²ãã‹ãšã®ã¶ã‚“ã ã‘ã€ãŠã‹ã­ã‚’ã—ãŸã®ã‚ãã«ã†ã”ã‹ãã†ã€‚ã²ã‘ãªã„ã¨ãã¯ã€ã¨ãªã‚Šã®ãã‚‰ã„ã‹ã‚‰ãã‚Šã•ã’ã¦ã€ã°ã‚‰ã«ã—ã‚ˆã†ã­ã€‚ã•ã„ã”ã«ã€ã²ã£ã•ã‚“ã®ã“ãŸãˆã‚’ã€ã«ã‚…ã†ã‚Šã‚‡ãã—ã¾ã™ã€‚", true);
                
                guideTimeoutIds.forEach(id => clearTimeout(id));
                guideTimeoutIds = [];

                const clearAllHighlights = () => {
                    document.querySelectorAll('.highlight-border').forEach(el => el.classList.remove('highlight-border'));
                };

                const setupItems = document.querySelectorAll('.setup-item');
                const modeSelect = setupItems[0];
                const autoAnswerSetting = setupItems[1];
                const startBtn = els.startBtn;
                const guideItems = document.querySelectorAll('.visual-guide-item');
                const guide1 = guideItems[0];
                const guide2 = guideItems[1];
                const guide3 = guideItems[2];

                clearAllHighlights();

                guideTimeoutIds.push(setTimeout(() => { 
                    clearAllHighlights(); 
                    if(modeSelect) modeSelect.classList.add('highlight-border'); 
                }, 3500));

                guideTimeoutIds.push(setTimeout(() => { 
                    clearAllHighlights(); 
                    if(autoAnswerSetting) autoAnswerSetting.classList.add('highlight-border'); 
                }, 5500));
                
                guideTimeoutIds.push(setTimeout(() => { 
                    clearAllHighlights(); 
                    if(startBtn) startBtn.classList.add('highlight-border'); 
                }, 8500));

                guideTimeoutIds.push(setTimeout(() => { 
                    clearAllHighlights(); 
                    if(guide1) guide1.classList.add('highlight-border'); 
                }, 11500));

                guideTimeoutIds.push(setTimeout(() => { 
                    clearAllHighlights(); 
                    if(guide2) guide2.classList.add('highlight-border'); 
                }, 17500));

                guideTimeoutIds.push(setTimeout(() => { 
                    clearAllHighlights(); 
                    if(guide3) guide3.classList.add('highlight-border'); 
                }, 23500));

                guideTimeoutIds.push(setTimeout(() => { 
                    clearAllHighlights(); 
                }, 29000));
            });
        }

        if (els.startBtn) {
            els.startBtn.addEventListener('click', async () => { 
                try {
                    document.querySelectorAll('.highlight-border').forEach(el => el.classList.remove('highlight-border'));
                    if ('speechSynthesis' in window) window.speechSynthesis.cancel();
                    if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; }

                    await unlockAudio(); 
                    state.isPlaying = true;
                    if(els.workspace) els.workspace.style.display = 'flex'; 
                    if(els.instruction) els.instruction.style.display = 'none'; 
                    if(els.headerControls) els.headerControls.style.display = 'flex'; 
                    if(els.backToHomeBtn) els.backToHomeBtn.style.display = 'inline-block';
                    if(els.startBtn) els.startBtn.style.display = 'none'; 
                    if(els.nextBtn) els.nextBtn.style.display = 'inline-block'; 
                    generateNextProblem(); 
                } catch (e) { console.error(e); }
            });
        }

        if (els.nextBtn) els.nextBtn.addEventListener('click', () => { unlockAudio(); generateNextProblem(); });
        if (els.checkBtn) els.checkBtn.addEventListener('click', () => { unlockAudio(); checkAnswer(); });
        if (els.modalClose) els.modalClose.addEventListener('click', () => { els.masterModal.style.display = 'none'; generateNextProblem(); });
        
        if (els.resetBtn) {
            els.resetBtn.addEventListener('click', () => {
                if (confirm("ã»ã‚“ã¨ã†ã« æœ€åˆã‹ã‚‰ ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã‚Œã¾ã§ã®è¨˜éŒ²ãŒ 0 ã«ãªã‚Šã¾ã™ï¼‰")) {
                    resetProgress();
                }
            });
        }
        
        if (els.backToHomeBtn) {
            els.backToHomeBtn.addEventListener('click', () => { 
                state.isPlaying = false;
                saveProgress();
                if(els.workspace) els.workspace.style.display = 'none'; 
                if(els.headerControls) els.headerControls.style.display = 'none'; 
                if(els.instruction) els.instruction.style.display = 'flex'; 
                if(els.backToHomeBtn) els.backToHomeBtn.style.display = 'none';
                if(els.startBtn) els.startBtn.style.display = 'block'; 
            });
        }

        Array.from(els.modeRadios || []).forEach(radio => {
            radio.addEventListener('change', e => {
                state.mode = e.target.value;
                if (state.mode === 'coin') {
                    if(els.coinTable) els.coinTable.classList.remove('mode-block');
                    if(els.coinTable) els.coinTable.classList.add('mode-coin');
                } else {
                    if(els.coinTable) els.coinTable.classList.remove('mode-coin');
                    if(els.coinTable) els.coinTable.classList.add('mode-block');
                }
                initVisuals();
                saveProgress();
            });
        });

        if (els.settingAnswer) {
            els.settingAnswer.addEventListener('change', e => {
                state.autoAnswer = e.target.checked;
                if (state.isDroppedDown) syncHissanWithBot();
                saveProgress();
            });
        }

        if (els.settingAudio) {
            els.settingAudio.addEventListener('change', e => {
                state.audioGuide = e.target.checked;
                saveProgress();
            });
        }

        document.addEventListener('mousemove', onDragMove); 
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchmove', onDragMove, {passive:false}); 
        document.addEventListener('touchend', onDragEnd);
    </script>
</body>
</html>
